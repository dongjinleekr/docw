#!/usr/bin/env bash

# The main executable script of docw.
# It provides a interactive command line interface, alongside with help messages.

# initialize env
BASE_DIR=$(dirname $(dirname $(readlink -f $0)))
. ${BASE_DIR}/common.sh

print_usage() {
  echo ""
  echo "Usage: docw [<command>] [<options>]"
  echo ""
  echo "  where command is one of:"
  echo "    ls                   display current status"
  echo "    mknode               create node"
  echo "    mknodes              create node(s)"
  echo "    format               format node(s)"
  echo "    mkcluster            create cluster"
  echo "    rmcluster            remove cluster"
  echo ""
  echo "  All commands print help when invoked without parameters"
  echo ""
}

print_ls_usage() {
  echo ""
  echo "Usage: docw ls [<options>]"
  echo ""
  echo "  where options are one of:"
  echo "    <cluster>            display <cluster>'s information."
  echo "    --all                display all clusters' and nodes' information."
  echo ""
}

print_mknode_usage() {
  echo ""
  echo "Usage: docw mknode <size>    create a single node whose core count is <size>"
  echo "                             hostnames are assigned automatically"
  echo ""
  echo "  For details on <size>, please refer https://www.digitalocean.com/pricing/"
  echo ""
}

print_mknodes_usage() {
  echo ""
  echo "Usage: docw mknodes <size> <count>     create <count> nodes with <size> cores at once"
  echo "                                       hostnames are assigned automatically"
  echo ""
  echo "  For details on <size>, please refer https://www.digitalocean.com/pricing/"
  echo ""
}

print_mkcluster_usage() {
  echo ""
  echo "Usage: docw mkcluster <name> <role> <hostname>* (--master <masterhost>)"
  echo ""
  echo "                                       create cluster <name> with given set of hosts"
  echo ""
  echo "  where role are one of:"
  echo "    hadoop                   setup hadoop cluster. namenode hostname should be given as an option"
  echo "                             The first specified host becomes namenode."
  echo "    zookeeper                setup zookeeper cluster. As there is no master node in zookeeper cluster,"
  echo "                             --master clause will be ignored in this case."
  echo ""
}

print_merge_usage() {
  echo ""
  echo "Usage: docw merge <lns>* <rns>         merge namespace <lns 1>, <lns 2>... into <rns>."
  echo ""
}

print_format_usage() {
  echo ""
  echo "Usage: docw format [<options>]"
  echo ""
  echo "  where options are one of:"
  echo "    --all                    format all unformatted nodes (recommended)"
  echo "    <hostname>*              format all given nodes"
  echo ""
  echo "  The format process includes:"
  echo "    1. configure given node's root password."
  echo "    2. Add the node to /etc/hosts."
  echo "    3. setup password-less login with the node."
  echo ""
}

print_rmcluster_usage() {
  echo ""
  echo "Usage: docw rmcluster <clustername>"
  echo ""
}

make_node() {
	[ "$#" -eq 2 ] || return 1
	
	HOSTNAME=$1
	SIZE=$2
	
	return 0
}

make_nodes() {
	[ "$#" -eq 2 ] || return 1
	
	SIZE=$1
	NODECOUNT=$2

	ID_START=$(cat ${ID_SEQUENCE_PATH})
	ID_END=$((${ID_START} + ${NODECOUNT} - 1))
	ID_NEXT=$((${ID_END} + 1))
	
	echo ${ID_NEXT} > ${ID_SEQUENCE_PATH}

	PID_LIST=""
	for I in $(seq ${ID_START} ${ID_END})
	do
		HOSTNAME=$(printf ${HOSTNAME_PREFIX} ${I})
		add_host ${HOSTNAME} ${SIZE} &
	PID_LIST=${PID_LIST}' '$!
	done
	
	wait_all ${PID_LIST}

	return 0
}

merge() {
	[ "$#" -ge 3 ] || return 1

	${PYTHON} ${SBIN_DIR}/registry.py ${REGISTRY_PATH} merge $@
	NAMESPACE_NAME=${@:$#}
	update_namespace_hosts ${NAMESPACE_NAME}
}

process_ls() {

	case $1 in
		"--all")
			display_all_clusters_info
		
			RETVAL=$?
			[ "${RETVAL}" -eq 0 ] && return 0
			;;
		"")
			print_ls_usage
			return 0
			;;
		*)
			CLUSTER_NAME=$1
			display_cluster_info ${CLUSTER_NAME}
			
			RETVAL=$?
			[ "${RETVAL}" -eq 0 ] && return 0
			;;
	esac
	
	return 1
}

process_format() {
	
	case $1 in
		"--all")
			HOSTNAMES=$(raw_hosts)
			format_hosts ${HOSTNAMES}
			;;
		"")
			print_format_usage
			return 0
			;;
		*)
			format_hosts $@
	
			return 0
			;;
	esac
}

case $1 in
  ""|-h)
		print_usage
		exit 0
		;;
	ls)
		shift 1
		process_ls $@
		
		RETVAL=$?
		if [ "${RETVAL}" -eq 0 ]; then
			exit 0
		else
			exit 1
		fi
		;;
	mknode)
		shift 1
		if [ "$#" -eq 0 ]; then
			print_mknode_usage
			exit 0
		else
			make_node $@
	
			RETVAL=$?
			if [ "${RETVAL}" -eq 0 ]; then
				exit 0
			else
				exit 1
			fi
		fi
		;;
	mknodes)
		shift 1
		if [ "$#" -eq 0 ]; then
			print_mknodes_usage
			exit 0
		else
			make_nodes $@
	
			RETVAL=$?
			if [ "${RETVAL}" -eq 0 ]; then
				exit 0
			else
				exit 1
			fi
		fi
		;;
	mkcluster)
		shift 1
		if [ "$#" -eq 0 ]; then
			print_mkcluster_usage
			exit 0
		else
			RESULT=$(validate_mkcluster $@)
			ARGS=( ${RESULT} )
			
			CLUSTER_NAME=${ARGS[0]}
			ROLE=${ARGS[1]}
			MASTER_HOSTNAME=${ARGS[2]}

			add_cluster ${CLUSTER_NAME} ${ROLE}
			add_namespace ${CLUSTER_NAME} ${CLUSTER_NAME}
			
			for HOSTNAME in ${ARGS[@]:2}
			do
				assign_to_namespace ${CLUSTER_NAME} ${HOSTNAME}
				assign_to_cluster ${CLUSTER_NAME} ${HOSTNAME}
			done

			update_namespace_hosts ${CLUSTER_NAME}

			case ${ROLE} in
				hadoop)
					configure_hadoop_slave_all ${CLUSTER_NAME} ${MASTER_HOSTNAME} # todo
					configure_master_host ${CLUSTER_NAME} ${ARGS[@]:2}
					configure_hadoop_master ${CLUSTER_NAME} ${MASTER_HOSTNAME}
		
					RETVAL=$?
					if [ "${RETVAL}" -eq 0 ]; then
						exit 0
					else
						exit 1
					fi
					;;
				zookeeper)
					configure_zookeeper_all ${ARGS[@]:2}
		
					RETVAL=$?
					if [ "${RETVAL}" -eq 0 ]; then
						exit 0
					else
						exit 1
					fi
					;;
				*)
					exit 1
					;;
			esac
		fi
		;;
	merge)
		shift 1
		if [ "$#" -eq 0 ]; then
			print_merge_usage
			exit 0
		else
			merge $@
	
			RETVAL=$?
			if [ "${RETVAL}" -eq 0 ]; then
				exit 0
			else
				exit 1
			fi
		fi
		;;
	format)
		shift 1
		process_format $@
		
		RETVAL=$?
		if [ "${RETVAL}" -eq 0 ]; then
			exit 0
		else
			exit 1
		fi
		;;
	rmcluster)
		shift 1
		if [ "$#" -eq 0 ]; then
			print_rmcluster_usage
			exit 0
		else
			rm_cluster $@
	
			RETVAL=$?
			if [ "${RETVAL}" -eq 0 ]; then
				exit 0
			else
				exit 1
			fi
		fi
		;;
	*)
		print_usage 1>&2
		exit 1
		;;
esac
